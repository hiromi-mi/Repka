<% provide(:title, 'Index') %>
<script>
Array.prototype.where = function(fun /*, thisp */) {
  "use strict";
  if (this == null) throw new TypeError();
  if (typeof fun != "function") throw new TypeError();

  var t = Object(this), res = [], len = t.length >>> 0, thisp = arguments[1];
  for (var i = 0; i < len; i++) {
    if (i in t) {
      var val = t[i];
      if (fun.call(thisp, val, i, t)) res.push(i);
    }
  }
  return res;
};

function initialize(config) {
  var ths = config.map(function(v) {
    return {
      id: 'ID',
      title: '授業名',
      teacher: '講師',
      year: '年度',
      kind: '種別',
      data: '',
      operation: '',
    }[v[0]];
  });
  var dt_columns = config.map(function(v) {
    var title = {
      id: 'ID',
      title: '授業名',
      teacher: '講師',
      year: '年度',
      kind: '種別',
      data: '',
      operation: '',
    }[v[0]];
    return {title: title, data: v[0]}; });
  var yadcf_columns = config.map(function(v, i) {
    if(v[1] === "text")
      return {
        column_number: i,
        filter_type: v[1],
        filter_delay: 2000,
        filter_container_id: 'col' + i + '_filter',
        filter_reset_button_text: false
      };
    else
      return {
        column_number: i,
        filter_type: 'none'
      };
  });

  // init
  var table = $('#pieces_table').DataTable({
    language: {
      url: "//cdn.datatables.net/plug-ins/3cfcc339e89/i18n/Japanese.json",
    },
    sDom: 'lrtip',
    aoColumnDefs: [{bSortable: false, aTargets: config.where(function(v) {
      return ['data', 'operation'].includes(v[0]);
    })}],
    processing: true,
    serverSide: true,
    ajax: $('#pieces_table').data('source'),
    pagingType: "full_numbers",
    columns: dt_columns,
  });

  yadcf.init(table, yadcf_columns);
}

$(function(){
  initialize([
      ['id'],
      ['title', 'text'],
      ['teacher', 'text'],
      ['year', 'text'],
      ['kind', 'text'],
      ['data'],
      <% if is_power_ge?(power_of(:shiketai)) %> ['operation'], <% end %>
  ]);
});
</script>
<div class="jumbotron">
  <h1>Repka</h1>
  <p>ぼくのかんがえたさいきょうの講義過去問管理検索システム</p>
</div>

<% if is_power_ge?(power_of(:shiketai)) %>
  <div id="management" class="item">
    <h2>管理</h2>
    <%= form_tag pieces_path, multipart: true do %>
      <%= file_field_tag :file %>
      <%= submit_tag 'submit' %>
    <% end %>
  </div>
<% end %>

<div class="item" id="search">
  <h2>けんさくけんさくぅっ↑</h2>
  <table>
    <tbody>
      <% rows = ['授業名', '講師', '年度', '種別'].each_with_index do |row, index| %>
        <tr>
          <td class="row_name"><%= "#{row}" %></td>
          <td id="col<%= "#{index + 1}" %>_filter"></td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<div class="item" id="pieces">
  <h2>一覧</h2>
  <table id="pieces_table" class="table table-striped table-bordered" data-source="<%= pieces_path(format: :json)%>">
    <thead></thead>
    <tbody></tbody>
    <tfoot></tfoot>
  </table>
</div>
